name: Deploy to Zoho Catalyst

on:
  push:
    branches: [feature/zoho-catalyst-deployment]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Catalyst Environment'
        required: true
        default: 'Development'
        type: choice
        options:
          - Development
          - Production

env:
  # Variables (non-sensitive - configure in Settings â†’ Variables)
  CATALYST_PROJECT_ID: ${{ vars.CATALYST_PROJECT_ID }}
  CATALYST_ORG_ID: ${{ vars.CATALYST_ORG_ID }}
  NODE_VERSION: '20'
  JAVA_VERSION: '21'

jobs:
  # ==========================================
  # Build Backend for Catalyst
  # ==========================================
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven (Catalyst profile)
        run: |
          mvn clean package -DskipTests -Pcatalyst

      - name: Prepare Catalyst function package
        run: |
          mkdir -p ../catalyst/functions/chartdb_backend/lib
          cp target/*.jar ../catalyst/functions/chartdb_backend/lib/
          
      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: catalyst-backend
          path: catalyst/functions/chartdb_backend/
          retention-days: 1

  # ==========================================
  # Build Frontend for Catalyst
  # ==========================================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build for Catalyst
        run: npm run build
        env:
          # Catalyst serves API from same domain with /server/ prefix
          VITE_API_URL: /server/chartdb_backend/api
          VITE_WS_URL: /server/chartdb_backend/ws
          VITE_BUILD_VERSION: ${{ github.run_number }}
          VITE_BUILD_COMMIT: ${{ github.sha }}
          VITE_BUILD_TIME: ${{ github.event.head_commit.timestamp }}

      - name: Prepare Catalyst client package
        run: |
          mkdir -p ../catalyst/client
          cp -r dist/* ../catalyst/client/

      - name: Upload frontend artifact
        uses: actions/upload-artifact@v4
        with:
          name: catalyst-frontend
          path: catalyst/client/
          retention-days: 1

  # ==========================================
  # Deploy to Zoho Catalyst
  # ==========================================
  deploy-to-catalyst:
    name: Deploy to Catalyst
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    environment: ${{ github.event.inputs.environment || 'Development' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: catalyst-backend
          path: catalyst/functions/chartdb_backend/

      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: catalyst-frontend
          path: catalyst/client/

      - name: Set up Node.js (for Catalyst CLI)
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Catalyst CLI
        run: npm install -g zcatalyst-cli

      - name: Authenticate with Catalyst
        run: |
          echo "${{ secrets.CATALYST_REFRESH_TOKEN }}" > ~/.catalyst_token
          catalyst auth:login --token-file ~/.catalyst_token
        env:
          CATALYST_ORG_ID: ${{ vars.CATALYST_ORG_ID }}

      - name: Deploy to Catalyst
        working-directory: ./catalyst
        run: |
          catalyst deploy --project ${{ vars.CATALYST_PROJECT_ID }}
        env:
          CATALYST_ORG_ID: ${{ vars.CATALYST_ORG_ID }}
          CATALYST_PROJECT_ID: ${{ vars.CATALYST_PROJECT_ID }}

      - name: Set Catalyst Environment Variables
        working-directory: ./catalyst
        run: |
          # Set environment variables in Catalyst
          catalyst env:set JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --project ${{ vars.CATALYST_PROJECT_ID }}
          
          # OAuth2 credentials (if configured)
          if [ -n "${{ secrets.GOOGLE_CLIENT_ID }}" ]; then
            catalyst env:set GOOGLE_CLIENT_ID="${{ secrets.GOOGLE_CLIENT_ID }}" \
              GOOGLE_CLIENT_SECRET="${{ secrets.GOOGLE_CLIENT_SECRET }}" \
              --project ${{ vars.CATALYST_PROJECT_ID }}
          fi
          
          if [ -n "${{ secrets.GITHUB_CLIENT_ID }}" ]; then
            catalyst env:set GITHUB_CLIENT_ID="${{ secrets.GITHUB_CLIENT_ID }}" \
              GITHUB_CLIENT_SECRET="${{ secrets.GITHUB_CLIENT_SECRET }}" \
              --project ${{ vars.CATALYST_PROJECT_ID }}
          fi
          
          if [ -n "${{ secrets.ZOHO_CLIENT_ID }}" ]; then
            catalyst env:set ZOHO_CLIENT_ID="${{ secrets.ZOHO_CLIENT_ID }}" \
              ZOHO_CLIENT_SECRET="${{ secrets.ZOHO_CLIENT_SECRET }}" \
              --project ${{ vars.CATALYST_PROJECT_ID }}
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Catalyst Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project ID:** ${{ vars.CATALYST_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'Development' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Client:** https://chartdb-${{ vars.CATALYST_PROJECT_ID }}.catalyst.zoho.com" >> $GITHUB_STEP_SUMMARY
          echo "- **API Endpoint:** https://chartdb-${{ vars.CATALYST_PROJECT_ID }}.catalyst.zoho.com/server/chartdb_backend" >> $GITHUB_STEP_SUMMARY
